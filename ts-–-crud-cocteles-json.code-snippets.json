{"generator":"Code Snippets v3.8.1","date_created":"2025-11-01 01:39","snippets":[{"id":17,"name":"TS \u2013 CRUD C\u00f3cteles JSON","code":"\n\/\/ Shortcode y handlers para gestionar cocteles en JSON\nadd_shortcode('cocteles_json', 'ts_cocteles_json');\nadd_action('wp_ajax_ts_guardar_coctel', 'ts_guardar_coctel_json');\nadd_action('wp_ajax_ts_eliminar_coctel', 'ts_eliminar_coctel_json');\nadd_action('wp_ajax_ts_editar_coctel', 'ts_editar_coctel_json');\n\n\/** Ruta del archivo JSON *\/\nfunction ts_ruta_json() {\n    $uploads = wp_upload_dir();\n    return trailingslashit($uploads['basedir']) . 'cocteles.json';\n}\n\n\/** Leer el JSON *\/\nfunction ts_leer_cocteles() {\n    $ruta = ts_ruta_json();\n    if (!file_exists($ruta)) file_put_contents($ruta, json_encode([], JSON_PRETTY_PRINT));\n    $data = json_decode(file_get_contents($ruta), true);\n    return is_array($data) ? $data : [];\n}\n\n\/** Guardar el JSON *\/\nfunction ts_guardar_datos($data) {\n    file_put_contents(ts_ruta_json(), json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));\n}\n\n\/** Crear c\u00f3ctel *\/\nfunction ts_guardar_coctel_json() {\n    if (!is_user_logged_in() || !current_user_can('edit_posts')) wp_send_json_error('No autorizado.');\n\n    $nombre = sanitize_text_field($_POST['nombre'] ?? '');\n    $ing = sanitize_textarea_field($_POST['ingredientes'] ?? '');\n    $medidas = sanitize_text_field($_POST['medidas'] ?? '');\n    $licor = sanitize_text_field($_POST['licor'] ?? '');\n    $cristal = sanitize_text_field($_POST['cristaleria'] ?? '');\n\n    $url_img = '';\n    if (!empty($_FILES['imagen']['name'])) {\n        require_once(ABSPATH . 'wp-admin\/includes\/file.php');\n        $upload = wp_handle_upload($_FILES['imagen'], ['test_form' => false]);\n        if (isset($upload['url'])) $url_img = esc_url_raw($upload['url']);\n    }\n\n    $data = ts_leer_cocteles();\n    $nuevo = [\n        'id' => uniqid('coctel_'),\n        'nombre' => $nombre,\n        'ingredientes' => $ing,\n        'medidas' => $medidas,\n        'licor' => $licor,\n        'cristaleria' => $cristal,\n        'imagen' => $url_img,\n        'fecha' => date('Y-m-d H:i:s')\n    ];\n    $data[] = $nuevo;\n    ts_guardar_datos($data);\n    wp_send_json_success($nuevo);\n}\n\n\/** Eliminar c\u00f3ctel *\/\nfunction ts_eliminar_coctel_json() {\n    \/\/ Permisos b\u00e1sicos\n    if (!is_user_logged_in() || !current_user_can('delete_posts')) {\n        wp_send_json_error('No tienes permisos para eliminar c\u00f3cteles.');\n        return;\n    }\n    \/\/ Validar ID recibido\n    if (empty($_POST['id'])) {\n        wp_send_json_error('Falta el ID del c\u00f3ctel.');\n        return;\n    }\n    $id = sanitize_text_field($_POST['id']);\n    \/\/ Leer datos del archivo JSON\n    $uploads = wp_upload_dir();\n    $ruta = trailingslashit($uploads['basedir']) . 'cocteles.json';\n\n    if (!file_exists($ruta)) {\n        wp_send_json_error('No existe el archivo JSON.');\n        return;\n    }\n    $data = json_decode(file_get_contents($ruta), true);\n    if (!is_array($data)) $data = [];\n\n    \/\/ Buscar y eliminar el c\u00f3ctel por su ID\n    $encontrado = false;\n    foreach ($data as $index => $coctel) {\n        if (isset($coctel['id']) && $coctel['id'] === $id) {\n            unset($data[$index]);\n            $encontrado = true;\n            break;\n        }\n    }\n    \/\/ Si no se encontr\u00f3, aviso\n    if (!$encontrado) {\n        wp_send_json_error('El c\u00f3ctel no se encontr\u00f3 en el archivo.');\n        return;\n    }\n    \/\/ Reindexar el array y guardar el nuevo JSON\n    $data = array_values($data);\n    file_put_contents($ruta, json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));\n\n    wp_send_json_success('C\u00f3ctel eliminado correctamente.');\n}\n\n\/** Renderizar lista de c\u00f3cteles con estilo *\/\nfunction ts_render_cocteles($data, $can_manage = false){\n    if(empty($data)) return '<p>No hay c\u00f3cteles a\u00fan.<\/p>';\n    $html = '<div class=\"ts-grid\">';\n    foreach(array_reverse($data) as $c){\n        $img_html = '';\n        if(!empty($c['imagen'])) $img_html = '<div class=\"ts-card-media\"><img src=\"'.esc_url($c['imagen']).'\" alt=\"'.esc_attr($c['nombre']).'\"><\/div>';\n        $html .= '<article class=\"ts-card\" data-id=\"'.esc_attr($c['id']).'\" data-ing=\"'.esc_attr($c['ingredientes']).'\" data-med=\"'.esc_attr($c['medidas']).'\" data-lic=\"'.esc_attr($c['licor']).'\" data-cris=\"'.esc_attr($c['cristaleria']).'\">';\n        $html .= $img_html;\n        $html .= '<div class=\"ts-card-body\">';\n        $html .= '<h3 class=\"ts-card-title\">'.esc_html($c['nombre']).'<\/h3>';\n        $html .= '<p class=\"ts-mini\"><strong>Licor:<\/strong> '.esc_html($c['licor']).'<\/p>';\n        $html .= '<p class=\"ts-mini ts-ing\"><strong>Ingredientes:<\/strong><br>'.nl2br(esc_html($c['ingredientes'])).'<\/p>';\n        $html .= '<p class=\"ts-mini\"><strong>Medidas:<\/strong> '.esc_html($c['medidas']).'<\/p>';\n        $html .= '<p class=\"ts-mini\"><strong>Cristaler\u00eda:<\/strong> '.esc_html($c['cristaleria']).'<\/p>';\n        $html .= '<\/div>'; \/\/ body\n        $html .= '<div class=\"ts-card-footer\">';\n        if($can_manage){\n            $html .= '<button class=\"ts-btn ts-del\" data-id=\"'.esc_attr($c['id']).'\">\ud83d\uddd1\ufe0f Eliminar<\/button>';\n        } else {\n            $html .= '<button class=\"ts-btn ts-view\" data-id=\"'.esc_attr($c['id']).'\">\ud83d\udd0d Ver<\/button>';\n        }\n        $html .= '<\/div>';\n        $html .= '<\/article>';\n    }\n    $html .= '<\/div>';\n    return $html;\n}\n\n\/** Shortcode principal *\/\nfunction ts_cocteles_json() {\n    $ajax = admin_url('admin-ajax.php');\n    $data = ts_leer_cocteles();\n    $user_can_manage = is_user_logged_in() && current_user_can('edit_posts');\n\n    ob_start(); ?>\n\n    <style>\n    \/* GRID y tarjetas *\/\n    .ts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin-top:20px}\n    .ts-card{background:#fff;border-radius:12px;overflow:hidden;border:1px solid #e8e8e8;box-shadow:0 6px 18px rgba(20,20,20,0.04);display:flex;flex-direction:column}\n    .ts-card-media{height:160px;overflow:hidden;background:#f7f7f7}\n    .ts-card-media img{width:100%;height:100%;object-fit:cover;display:block}\n    .ts-card-body{padding:12px;flex:1}\n    .ts-card-title{margin:0 0 8px;font-size:1.05rem;color:#222}\n    .ts-mini{margin:6px 0;color:#555;font-size:.95rem;line-height:1.3}\n    .ts-card-footer{display:flex;gap:8px;justify-content:flex-end;padding:10px;border-top:1px solid #f0f0f0;background:#fafafa}\n    .ts-btn{background:#0b78d1;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:.95rem;transition:all .12s}\n    .ts-btn:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(11,120,209,0.12)}\n    .ts-btn.ts-del{background:#e14b4b}\n    .ts-btn.ts-edit{background:#ffb400;color:#222}\n    .ts-btn.ts-view{background:#6c757d}\n    \/* Form *\/\n    .ts-form{max-width:720px;margin:0 auto 10px;display:flex;flex-direction:column;gap:10px;padding:14px;background:#fff;border-radius:12px;border:1px solid #eee}\n    .ts-form input[type=\"text\"], .ts-form textarea {padding:10px;border-radius:8px;border:1px solid #ddd;width:100%}\n    .ts-form input[type=\"file\"]{padding:6px}\n    .ts-form button[type=\"submit\"]{width:160px;padding:10px;border-radius:8px;border:none;background:#0b78d1;color:#fff;cursor:pointer}\n    \/* Modal *\/\n    .ts-modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;padding:20px}\n    .ts-modal{background:#fff;border-radius:12px;max-width:680px;width:100%;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,0.25);max-height:90vh;overflow:auto}\n    .ts-modal img{width:60%;max-width:320px;display:block;margin:0 auto 12px;border-radius:8px}\n    .ts-center{max-width:980px;margin:0 auto;padding:20px}\n    @media (max-width:600px){ .ts-card-media{height:130px} .ts-modal img{width:100%} }\n    <\/style>\n\n    <div class=\"ts-center\">\n      <?php if($user_can_manage): ?>\n      <form id=\"ts-form-coctel\" class=\"ts-form\" enctype=\"multipart\/form-data\">\n        <input type=\"hidden\" id=\"coctel-id\" name=\"id\" value=\"\">\n        <input type=\"text\" name=\"nombre\" placeholder=\"Nombre del c\u00f3ctel\" required>\n        <textarea name=\"ingredientes\" placeholder=\"Ingredientes\" rows=\"3\" required><\/textarea>\n        <input type=\"text\" name=\"medidas\" placeholder=\"Medidas\" required>\n        <input type=\"text\" name=\"licor\" placeholder=\"Licor\" required>\n        <input type=\"text\" name=\"cristaleria\" placeholder=\"Cristaler\u00eda\" required>\n        <label style=\"font-size:.9rem;color:#444\">Imagen (opcional)<\/label>\n        <input type=\"file\" name=\"imagen\" accept=\"image\/*\">\n        <div style=\"display:flex;gap:10px;align-items:center\">\n          <button type=\"submit\">Guardar C\u00f3ctel<\/button>\n          <div id=\"ts-msg\" style=\"font-size:.95rem;color:#333\"><\/div>\n        <\/div>\n      <\/form>\n      <?php else: ?>\n        <p style=\"text-align:center;color:#666\">Lista de c\u00f3cteles disponibles. Si eres administrador o bartender, inicia sesi\u00f3n para administrar.<\/p>\n      <?php endif; ?>\n\n      <div id=\"ts-lista\"><?php echo ts_render_cocteles($data, $user_can_manage); ?><\/div>\n    <\/div>\n\n    <!-- Modal detalle -->\n    <div id=\"ts-modal-backdrop\" class=\"ts-modal-backdrop\" role=\"dialog\" aria-hidden=\"true\">\n      <div class=\"ts-modal\" role=\"document\" aria-modal=\"true\">\n        <button id=\"ts-close-modal\" style=\"float:right;border:none;background:transparent;font-size:20px;cursor:pointer\">\u2716<\/button>\n        <div id=\"ts-modal-content\"><\/div>\n      <\/div>\n    <\/div>\n\n    <script>\n    (function(){\n      const ajax = '<?php echo esc_url($ajax); ?>';\n      const form = document.getElementById('ts-form-coctel');\n      const msg = document.getElementById('ts-msg');\n      const lista = document.getElementById('ts-lista');\n      const modalBackdrop = document.getElementById('ts-modal-backdrop');\n      const modalContent = document.getElementById('ts-modal-content');\n      const closeModalBtn = document.getElementById('ts-close-modal');\n\n      \/\/ Enviar nuevo o editar (solo si existe formulario)\n      if(form){\n        form.addEventListener('submit', async function(e){\n          e.preventDefault();\n          msg.style.color = '#333';\n          msg.textContent = 'Guardando...';\n          const data = new FormData(form);\n          const id = data.get('id');\n          data.append('action', id ? 'ts_editar_coctel' : 'ts_guardar_coctel');\n          try {\n            const res = await fetch(ajax, { method:'POST', body:data });\n            const json = await res.json();\n            if(json.success){\n              msg.style.color = 'green';\n              msg.textContent = typeof json.data === 'string' ? json.data : 'Guardado correctamente.';\n              form.reset();\n              \/\/ recargar lista de forma simple: pedir la p\u00e1gina y extraer #ts-lista\n              const r = await fetch(window.location.href);\n              const t = await r.text();\n              const temp = document.createElement('div'); temp.innerHTML = t;\n              const nueva = temp.querySelector('#ts-lista');\n              if(nueva) lista.innerHTML = nueva.innerHTML;\n            } else {\n              msg.style.color = 'red';\n              msg.textContent = json.data || 'Error';\n            }\n          } catch(err) {\n            msg.style.color = 'red';\n            msg.textContent = 'Error al guardar.';\n          }\n        });\n      }\n\n      \/\/ Delegar clicks en la lista\n      lista.addEventListener('click', async function(e){\n        const target = e.target;\n        \/\/ eliminar\n        if(target.classList.contains('ts-del')){\n          if(!confirm('\u00bfEliminar este c\u00f3ctel?')) return;\n          const id = target.dataset.id;\n          const fd = new FormData(); fd.append('id', id); fd.append('action', 'ts_eliminar_coctel');\n          const resp = await fetch(ajax, { method:'POST', body:fd }); const j = await resp.json();\n          if(j.success){\n            target.closest('article').remove();\n          } else {\n            alert(j.data || 'Error al eliminar');\n          }\n        }\n        \/\/ editar (cargar datos en form)\n        if(target.classList.contains('ts-edit')){\n          const art = target.closest('article');\n          if(!form) { alert('Debes iniciar sesi\u00f3n para editar.'); return; }\n          form.querySelector('[name=id]').value = art.dataset.id;\n          form.querySelector('[name=nombre]').value = art.querySelector('.ts-card-title').textContent.trim();\n          form.querySelector('[name=ingredientes]').value = art.dataset.ing || '';\n          form.querySelector('[name=medidas]').value = art.dataset.med || '';\n          form.querySelector('[name=licor]').value = art.dataset.lic || '';\n          form.querySelector('[name=cristaleria]').value = art.dataset.cris || '';\n          form.scrollIntoView({behavior:'smooth'});\n        }\n        \/\/ ver (abrir modal)\n        if(target.classList.contains('ts-view') || target.closest('.ts-card-media')){\n          const art = target.closest('article');\n          const id = art.dataset.id;\n          const nombre = art.querySelector('.ts-card-title').textContent;\n          const img = art.querySelector('.ts-card-media img') ? art.querySelector('.ts-card-media img').src : '';\n          const ingredientes = art.dataset.ing || '';\n          const medidas = art.dataset.med || '';\n          const licor = art.dataset.lic || '';\n          const crist = art.dataset.cris || '';\n          modalContent.innerHTML = `\n            <h2 style=\"margin-top:0\">${escapeHtml(nombre)}<\/h2>\n            ${ img ? `<img src=\"${escapeHtml(img)}\" alt=\"${escapeHtml(nombre)}\">` : '' }\n            <h4>Ingredientes<\/h4><p>${nl2brHtml(escapeHtml(ingredientes))}<\/p>\n            <p><strong>Medidas:<\/strong> ${escapeHtml(medidas)}<\/p>\n            <p><strong>Licor:<\/strong> ${escapeHtml(licor)}<\/p>\n            <p><strong>Cristaler\u00eda:<\/strong> ${escapeHtml(crist)}<\/p>\n          `;\n          modalBackdrop.style.display = 'flex';\n          closeModalBtn.focus();\n        }\n      });\n\n      if(closeModalBtn){\n        closeModalBtn.addEventListener('click', ()=> { modalBackdrop.style.display='none'; });\n        modalBackdrop.addEventListener('click', (e)=> { if(e.target === modalBackdrop) modalBackdrop.style.display='none'; });\n        document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') modalBackdrop.style.display='none'; });\n      }\n\n      \/\/ helpers\n      function escapeHtml(str){ return String(str||'').replace(\/&\/g,'&amp;').replace(\/<\/g,'&lt;').replace(\/>\/g,'&gt;').replace(\/\"\/g,'&quot;').replace(\/'\/g,'&#039;'); }\n      function nl2brHtml(s){ return String(s||'').replace(\/\\n\/g,'<br>'); }\n    })();\n    <\/script>\n\n    <?php\n    return ob_get_clean();\n}","active":true,"modified":"2025-11-01 00:55:04","revision":"1"}]}